# Sage syntax cache (`.sagec`) + index (`index.bin`) — format v2

This document specifies the binary formats produced by `sage --compile-cache` and consumed by `sage` at runtime for syntax highlighting.

Reviewed: 2026-02-09

---

## Scope and stability

This is an implementation-oriented spec of the current on-disk format:
- `*.sagec` files: compiled syntax caches
- `index.bin`: key → cache filename lookup table

The format is intentionally small and fast to parse. It is not (yet) presented as a stable public interface; future versions may bump the format version.

## Conventions

- **Byte order**: all integer fields are **little-endian**.
- **Integer types**:
  - `u8`: 1 byte
  - `u16`: 2 bytes
  - `u32`: 4 bytes
  - `u64`: 8 bytes
- **Strings/byte sequences**:
  - Stored as **length-prefixed raw bytes** (not NUL-terminated).
  - Typically UTF-8/ASCII, but readers should treat them as opaque byte sequences.
- **Offsets** in the tables below are from the start of the file (0-based).

## Files on disk (XDG)

When compiled, caches are stored under:

- `XDG_CACHE_HOME/sage/syntax/index.bin`
- `XDG_CACHE_HOME/sage/syntax/<cache>.sagec`

`index.bin` is required for runtime lookup: it maps a **key** (usually a lowercase extension like `js`, or a basename like `makefile`) to a cache filename like `textmate_c.sagec`.

Cache filenames are flattened from their source-relative paths so multiple directories can coexist without collisions (e.g. `textmate/c.tmLanguage` → `textmate_c.sagec`).

---

## `*.sagec` file format (syntax cache)

### Overview

A `.sagec` file contains:

1) a fixed header,
2) an extension list (currently informational), and
3) a list of token-classified regex patterns (“rules”).

At runtime, `sage` loads exactly one `.sagec` for a file (via `index.bin`), then groups rules by token kind and compiles combined regexes.

### Header (24 bytes)

| Offset | Size | Type | Name | Meaning |
|---:|---:|---:|---|---|
| 0  | 8 | `u64` | `magic` | File type tag (see below) |
| 8  | 4 | `u32` | `version` | Format version (must equal 2) |
| 12 | 4 | `u32` | `flags` | Range-highlighting bitset (see “Flags”) |
| 16 | 4 | `u32` | `ext_count` | Number of extension entries |
| 20 | 4 | `u32` | `rule_count` | Number of rule entries |

#### `magic`

`magic` MUST equal:
- hex: `0x58594E535F454741`
- bytes on disk (little-endian): `41 47 45 5F 53 4E 59 58` (ASCII: `AGE_SNYX`)

Readers MUST reject files with a non-matching magic.

#### `version`

`version` MUST equal `2`. Readers SHOULD reject other versions.

### Flags (`flags: u32`)

`flags` is a bitset that enables lightweight, stateful range-highlighting across wrapped viewport segments (to avoid false positives inside strings/comments).

| Bit | Hex | Name | Meaning (delimiter model) |
|---:|---:|---|---|
| 0 | `0x00000001` | `SYN_F_LINE_COMMENT_SLASH` | `// ... <newline>` |
| 1 | `0x00000002` | `SYN_F_BLOCK_COMMENT_C` | `/* ... */` |
| 2 | `0x00000004` | `SYN_F_STRING_SQ` | `' ... '` |
| 3 | `0x00000008` | `SYN_F_STRING_DQ` | `" ... "` |
| 4 | `0x00000010` | `SYN_F_STRING_BT` | `` ` ... ` `` |

Unknown bits MUST be ignored by readers (reserved for future expansion).

### Extensions block

Immediately after the header comes `ext_count` extension entries.

Each extension entry:

| Field | Type | Meaning |
|---|---:|---|
| `len` | `u16` | Number of bytes in the extension key |
| `bytes` | `u8[len]` | Raw bytes of the key (typically ASCII lowercase) |

Notes:
- In the current runtime, the extension list is not used for lookup (that’s `index.bin`’s job). It is kept as cache metadata and for future tooling.
- Writers may truncate extension strings to `65535` bytes (because `len` is `u16`).

### Rules block

After the extensions block, the file contains `rule_count` rule entries.

Each rule entry:

| Field | Type | Meaning |
|---|---:|---|
| `tok` | `u8` | Token kind (see table below) |
| `pat_len` | `u32` | Pattern length in bytes |
| `pat` | `u8[pat_len]` | Regex pattern bytes (runtime-regex dialect) |

Notes:
- Rule patterns are stored uncompiled; `sage` compiles them at runtime.
- Readers SHOULD skip unknown `tok` values by consuming `pat_len` bytes.
- Writers SHOULD keep patterns reasonably sized; runtimes may enforce internal caps when building combined regexes.

### Token kinds (`tok: u8`)

Token IDs used by `.sagec`:

| ID | Name | Typical meaning |
|---:|---|---|
| 0 | `TOK_NONE` | “no style” (normally not emitted as a rule) |
| 1 | `TOK_COMMENT` | comments |
| 2 | `TOK_STRING` | strings |
| 3 | `TOK_NUMBER` | numbers |
| 4 | `TOK_KEYWORD` | keywords |
| 5 | `TOK_TYPE` | types |
| 6 | `TOK_FUNCTION` | function names |
| 7 | `TOK_CONSTANT` | constants |
| 8 | `TOK_OPERATOR` | operators/punctuation |
| 9 | `TOK_HEADING` | headings (markup) |
| 10 | `TOK_EMPHASIS` | emphasis/bold/italic (markup) |
| 11 | `TOK_PREPROC` | preprocessor / directives |

---

## `index.bin` file format (compiled syntax index)

### Purpose

`index.bin` maps a lookup **key** to a cache filename:

- keys are typically extensions like `js`, `md`, `c`, but may also be basenames like `makefile` or dotfile names like `.gitignore`.
- values are cache filenames like `textmate_c.sagec` stored in the same directory as `index.bin`.

### Header (16 bytes)

| Offset | Size | Type | Name | Meaning |
|---:|---:|---:|---|---|
| 0  | 8 | `u64` | `magic` | File type tag (see below) |
| 8  | 4 | `u32` | `version` | Format version (must equal 2) |
| 12 | 4 | `u32` | `count` | Number of entries |

#### `magic`

`magic` MUST equal:
- hex: `0x58444E495F454741`
- bytes on disk (little-endian): `41 47 45 5F 49 4E 44 58` (ASCII: `AGE_INDX`)

Readers MUST reject files with a non-matching magic.

#### `version`

`version` MUST equal `2`. Readers SHOULD reject other versions.

### Entries

After the header, `count` entries are stored back-to-back.

Each entry:

| Field | Type | Meaning |
|---|---:|---|
| `key_len` | `u16` | Key length in bytes |
| `key` | `u8[key_len]` | Key bytes (typically ASCII lowercase) |
| `file_len` | `u16` | Cache filename length in bytes |
| `file` | `u8[file_len]` | Cache filename bytes (e.g. `textmate_c.sagec`) |

Notes:
- Duplicate keys are allowed.
- **Collision semantics**: if multiple entries match a key, `sage` uses “last match wins” (later entries override earlier ones).
- Writers may truncate `key` / `file` strings to `65535` bytes (because lengths are `u16`).

---

## Implementation notes (informative)

These are properties of the current `sage` implementation that are useful when generating or debugging caches:

- Compile-time rule cap: writers may cap per-syntax rules (currently 256) to keep runtime highlighting fast.
- Runtime grouping: `sage` groups rules by token kind and builds one combined regex per token kind using `(?:pat1)|(?:pat2)|...`.
- Fixed runtime paint precedence: highlighting applies token kinds in a fixed order (comments/strings first; then preproc, numbers, keywords, types, functions, constants, headings, emphasis, operators), and only paints bytes not already styled.
- Range flags first: when range flags are present (`flags != 0`), `sage` paints `//`, `/* */`, and/or quote-delimited string ranges with a lightweight state machine before applying regex rules, so keyword rules don’t fire inside those regions across wrapped segments.

